<!DOCTYPE html>
<html>
	<head>
	<title><%= decision.title %></title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel='stylesheet' href='/stylesheets/style.css' />
	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body>
	<h1 class="input-allowed text-center" id="title"><%= decision.title %> <i class="fa fa-edit"></i></h1>
	<p class="input-allowed text-center" id="subtitle"><%= decision.subtitle %> <i class="fa fa-edit"></i></p>


	<div class="all-criterias-show"></div>
	<div class="all-criterias" id="criterias-pad">
		<% 	for (var i = 0; i < decision.criteria.length; i ++ ){ %>
			<% var crit = decision.criteria[i];
			if (crit.parentId == 'criterias-pad'){
			 %>
			<div class="criteria color-<%= crit.color %>" id="criteria-<%= crit.id %>" draggable="true" data-color="<%= crit.color %>" data-criteria="<%= crit.id %>"><%= crit.title %></div>

			<% }
		} %>
		<div class="criteria new-criteria">+</div>
	</div>	
	<table id="decision-maker" width="100%">
		<thead>
			<tr>
				<th class="disabled" id="choice-heading">Choices</th>
				<% for(var j = 0; j < decision.priorities.length; j++ ){ 
						var priority = decision.priorities[j];


						var critChild = function(element) {
							return element.parentId === 'priority-' + priority.id;
						}



						var child = decision.criteria.find(critChild);

					%>
					<th class="computed-width priority <%= (child) ? 'color-' + child.color : 'empty '; %>" id="priority-<%= priority.id %>" <%= (child) ? 'data-color=color-' + child.color : ''; %>>
						<% if (child) { %>
						<div class="criteria color-<%= child.color %>" id="criteria-<%= child.id %>" draggable="true" data-color="<%= child.color %>" data-criteria="<%= child.id %>"><%= child.title %></div>
						<% } %>
						<p class="percent" data-priority="<%= priority.id %>"><%= priority.columnWidth %>%</p> 
					</th>
				<% } %>
				<th class="disabled" id="final-heading">Decision</th>
			</tr>
		</thead>
		<tbody>
		<% for (var i =0; i < decision.choices.length; i ++) {
			var choice = decision.choices[i];
		 %>
			<tr class="choice-row" data-choice="<%= choice.id %>">
				<td class="disabled first-col"><p class="input-allowed choice" id="choice-<%= choice.id %>" data-choice="<%= choice.id %>"><%= choice.title %> <i class="fa fa-edit"></i></p><i class="fa fa-trash-o trash-button"></i></td>
				<% for(var j = 0; j < decision.priorities.length; j++ ){
					var priority = decision.priorities[j]; %>
					<td class="result">
						<p class="p-result" data-choice="<%= choice.id %>" data-criteria="<%= priority.id %>" id="criteria-<%= priority.id %>-result-choice-<%= choice.id %>"></p>
						<nav class="rank" data-choice="<%= choice.id %>" data-criteria="<%= priority.id %>">
							<input class="rank-choice" type="radio" data-choice="<%= choice.id %>" name="criteria-<%= priority.id %>-choice-<%= choice.id %>" value="1" id="1-criteria-<%= priority.id %>-choice-<%= choice.id %>" <%= (choice.ranks[j] == 1) ? 'checked' : ''; %>>
							<label for="1-criteria-<%= priority.id %>-choice-<%= choice.id %>">1</label>
							<input class="rank-choice" type="radio" data-choice="<%= choice.id %>"name="criteria-<%= priority.id %>-choice-<%= choice.id %>" value="2" id="2-criteria-<%= priority.id %>-choice-<%= choice.id %>" <%= (choice.ranks[j] == 2) ? 'checked' : ''; %>>
							<label for="2-criteria-<%= priority.id %>-choice-<%= choice.id %>">2</label>
							<input class="rank-choice" type="radio" data-choice="<%= choice.id %>"name="criteria-<%= priority.id %>-choice-<%= choice.id %>" value="3" id="3-criteria-<%= priority.id %>-choice-<%= choice.id %>" <%= (choice.ranks[j] == 3) ? 'checked' : ''; %>>
							<label for="3-criteria-<%= priority.id %>-choice-<%= choice.id %>">3</label>
							<input class="rank-choice" type="radio" data-choice="<%= choice.id %>"name="criteria-<%= priority.id %>-choice-<%= choice.id %>" value="4" id="4-criteria-<%= priority.id %>-choice-<%= choice.id %>" <%= (choice.ranks[j] == 4) ? 'checked' : ''; %>>
							<label for="4-criteria-<%= priority.id %>-choice-<%= choice.id %>">4</label>
							<input class="rank-choice" type="radio" data-choice="<%= choice.id %>"name="criteria-<%= priority.id %>-choice-<%= choice.id %>" value="5" id="5-criteria-<%= priority.id %>-choice-<%= choice.id %>" <%= (choice.ranks[j] == 5) ? 'checked' : ''; %>>
							<label for="5-criteria-<%= priority.id %>-choice-<%= choice.id %>">5</label>
						</nav>
					</td>
				<% } %>
				<td class="disabled"><p class="decision p-result" id="decision-calc-<%= choice.id %>" data-choice="<%= choice.id %>"></p></td>
			</tr>
		<% } %>
			<tr>
				<td class="disabled" id="new-row"></td>
			<% for (var i =0; i < decision.priorities.length; i ++) { %>
				<td></td>
			<% } %>
				<td class="disabled"></td>
			</tr>
		</tbody>
	</table>
	<div class="large-numbers-description">
		<nav class="large-numbers-button">
			<span>Large Numbers are</span>
			<input type="radio" name="large-num" value="good" id="large-good" <%= (decision.largeNumbers ==='good') ? 'checked' : ''; %>>
			<label for="large-good" class="first">Good</label>
			<input type="radio" name="large-num" value="bad" id="large-bad" <%= (decision.largeNumbers ==='good') ? '' : 'checked' ; %>>
			<label for="large-bad">Bad</label>
		</nav>
		<div class="large-numbers-result">
			<p class="large-result <%= (decision.largeNumbers ==='good') ? '' : 'hide-opacity'; %>" id="large-result-good">High Ratings</p>
			<p class="large-result <%= (decision.largeNumbers ==='good') ? 'hide-opacity' : ''; %>" id="large-result-bad">High Costs</p>
		</div>
	</div> 
	<button class="button" id="save-button">Save</button>
	<script type="text/javascript" src="/javascripts/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/colresizable-1.6.min.js"></script>

	<script>
		$(function(){



			var calculateAllRanks = function() {
				$(".result").each(calculateRank);
			}

			var calculateRank = function(e){
				var width = totalWidth();
				var square = $(this);
				var i = 0;
				while (!square.hasClass('result')  && i < 20) {
					square = square.parent();
					i++;
				}
				
				var valueChecked = parseInt(square.children('.rank').children('input:checked').val());
				square.children('.p-result')[0].innerText = Math.round(square.width() / width * 100 * valueChecked);
				var choice = square.children('.p-result').attr('data-choice');
				var totalRow = 0;
				$('.p-result:not(.decision)[data-choice=' + choice + ']').each(function(){
					totalRow = parseInt(this.innerText) + totalRow;
				})

				$('.decision.p-result[data-choice=' + choice + ']')[0].innerText = totalRow;
			}

			var saveToken = function() {
				var hash = window.location.pathname.substring(1, window.location.pathname.length);
				var token = document.cookie.substring(6, document.cookie.length);
				if (token) { localStorage.setItem(hash, token); }
			}

			var jsonifyDecison = function(){
				var decision = {}	

			    var getJSONOfAttributes = function(selector, attributes){
			    	var all = [];
			    	$.each($(selector), function(i, obj){
			    		var temp = {};
			    		for (var i = 0; i < attributes.length; i ++){
			    			if (obj[attributes[i]]) {
			    				temp[attributes[i]] = obj[attributes[i]];
			    			}
			    			if (obj.dataset[attributes[i]]) {
			    				temp[attributes[i]] = obj.dataset[attributes[i]];
			    			}
			    		}
			    		all.push(temp);
			    	})
			    	return all;
			    }

			    var changeAttrName = function(obj, origName, newName) {
			    	obj[newName] = obj[origName];
			    	delete obj[origName];
			    	return obj;
			    }

			    var changeAllAttributes = function(arr, origName, newName) {
			    	var newArr = [];
			    	for (var i = 0; i < arr.length; i ++){
			    		newArr.push(changeAttrName(arr[i], origName, newName));
			    	}
			    	return newArr;
			    }


			    var filterByAttr = function(arr, attr, val){
			    	var final = [];
			    	for (var i = 0; i < arr.length; i ++){

			    		if (arr[i][attr] && arr[i][attr] == val) {
			    			final.push(arr[i]);
			    		}
			    	}
			    	return final;
			    }

			    var getParentId = function(id) {
			    	return $('#' + id).parent().attr('id');
			    }

			    

			    decision.title = $('#title').text();
			    decision.subtitle = $('#subtitle').text();
			    decision.largeNumbers = $('.large-numbers-button input:checked').val();
			    var choices = getJSONOfAttributes('.choice', ['innerText', 'choice']);
			    var criteria = getJSONOfAttributes('.criteria:not(.new-criteria)', ['innerText', 'criteria', 'color']);
			    var priorities = getJSONOfAttributes('.percent', ['innerText', 'priority']);
			    var ranks = getJSONOfAttributes('.rank-choice:checked', ['value', 'choice']);
			    priorities = changeAllAttributes(priorities, 'innerText', 'columnWidth');
			    priorities = changeAllAttributes(priorities, 'priority', 'id');
			    choices = changeAllAttributes(choices, 'innerText', 'title');
			    choices = changeAllAttributes(choices, 'choice', 'id');
			    criteria = changeAllAttributes(criteria, 'innerText', 'title');
			    criteria = changeAllAttributes(criteria, 'criteria', 'id');


			    for (var i = 0; i < choices.length; i ++){
			    	var thisRank = filterByAttr(ranks, 'choice', choices[i].id);
			    	choices[i].ranks = [];
			    	var temp = {};
			    	for (var j = 0; j < thisRank.length; j ++){
			    		temp[j] = thisRank[j].value;
			    		choices[i].ranks.push(thisRank[j].value);
			    	}
			    }

			    for (var i = 0; i < criteria.length; i ++ ){
			    	criteria[i].parentId = getParentId('criteria-' + criteria[i].id);
			    }

			    decision.choices = choices;
			    decision.criteria = criteria;
			    decision.priorities = priorities;
			    return decision;
			}

			var postDecision = function() {
				var putUrl = "/api/decisions" + window.location.href.substring(window.location.href.lastIndexOf('/'), window.location.href.length);
				var data = jsonifyDecison();
				var hash = window.location.pathname.substring(1, window.location.pathname.length);
				var token = localStorage.getItem(hash);
				console.log(JSON.stringify(data));
				if (token) {
					$.ajax({
						url: putUrl,
						method: 'put',
						data: JSON.stringify(data),
						contentType: 'application/json',
						headers: {
							"Authorization": token
						}


					}).done(function(data){
						console.log(data);
					});
				} else {
					alert("you are not authorized to save this");
				}
			}

			var addChoice = function() {
				var setChildren = function() {
					if ($(this).attr('id')) {
						var id = $(this).attr('id');
						$(this).attr('id', id.substring(0, id.lastIndexOf("-") + 1) + newChoice);
					}
					if ($(this).attr('data-choice') ) {
						$(this).attr('data-choice', newChoice);
					}
					if ($(this).attr('for') ) {
						var prevFor = $(this).attr('for');
						$(this).attr('for', prevFor.substring(0, prevFor.lastIndexOf("-") + 1) + newChoice);
					}
					if ($(this).attr('name') ) {
						var prevName = $(this).attr('name');
						$(this).attr('name', prevName.substring(0, prevName.lastIndexOf("-") + 1) + newChoice);
					}
					if ($(this).children().length > 0) {
						$(this).children().each(setChildren);
					}
				}

				$('.trash-button').removeClass('disable');
				var newChoice = parseInt($('.choice-row').last().attr('data-choice')) + 1;
				var newRow = $('.choice-row').last().clone().insertAfter($('.choice-row').last());
				newRow.attr('data-choice', newChoice);
				if (newRow.children().length > 0 ) {
					newRow.children().each(setChildren);
				}
				$('input[type=radio].rank-choice').change(calculateRank);

			}	

			var deleteChoice = function (event) {
				var row = $(event.target);
				var i = 0;
				while (! row.hasClass('choice-row') && i < 20) {
					row = row.parent();
					i++;
				}
				if ($('.' + row[0].classList[0]).length > 1){
					row.remove();
				} else {
					$('.trash-button').addClass('disable');
				}
			}

			var toggleLargeNumbers = function(){
				$('.large-result').toggleClass('hide-opacity');
			};
			var css2json = function(css) {
			    var s = {};
			    if (!css) return s;
			    if (css instanceof CSSStyleDeclaration) {
			        for (var i in css) {
			        	if (css[i]){
			            if ((css[i]).toLowerCase) {
			                s[(css[i]).toLowerCase()] = (css[css[i]]);
			            }}
			        }
			    } else if (typeof css == "string") {
			        css = css.split("; ");
			        for (var i in css) {
			            var l = css[i].split(": ");
			            s[l[0].toLowerCase()] = (l[1]);
			        }
			    }
			    return s;
			};
			var inputStyle = {
				"-webkit-appearance": "textfield", 
				"user-select": "text", 
				"cursor": "auto", 
				"border-width": "2px", 
				"border-style": "inset", 
				"border-color": "initial", 
				"border-image": "initial", 
				"-webkit-rtl-ordering": "logical", 
				"text-rendering": "auto", 
				"-webkit-writing-mode": "horizontal-tb"
			};

			var allowEdit = function (e){
				while (! e.target.className.includes('input-allowed')) {
					e.target = e.target.parentElement;
				}
				var origTarget = $(e.target);
				var text = origTarget[0].innerText.trim();
				var origCss = window.getComputedStyle(origTarget[0], null);
				var input = origTarget.before('<input class="input-class"/>').prev('input');
				input
					.val(text)
					.css(css2json(origCss))
					.css(inputStyle)
					.focus(function(){
						$(this).css("outline", "-webkit-focus-ring-color auto 5px");
					})
					.on('keyup', function(e){
					var origTarget = $(e.target).next('.input-allowed');
					if (e.keyCode === 13) {
				        origTarget[0].innerText = $(e.target).val() + ' ';
				        origTarget.append('<i class="fa fa-edit"></i>');
				        $(e.target).remove();
				    }
				});
				// Delete after css applied
				origTarget[0].innerText = '';
			}

			var newcriteria = function(e){
		        var lastId = $('.criteria:not(.new-criteria)').length + 1;
		        var newLastId = 'criteria-' + lastId;
				$('<input class="criteria color-1" id="' + newLastId + '"></>')
					.insertBefore(e.target)
					.on('keyup', function(e){
						if (e.keyCode === 13) {
					        var newDec = $(e.target).val();
					        $('<div class="criteria color-1" id="' + e.target.id + '" draggable="true"></div>').insertBefore(e.target);
				        	$('#'+newLastId).click(cycleColor)
				        		.on("dragstart", dragStart)
				        		.on("touchstart", handleTouch)
				        		.on("touchmove", handleTouch)
				        		.on("touchend", handleTouch)
				        		.on("touchcancel", handleTouch)
				        		.attr('data-color', 1)
				        		.attr('data-criteria', lastId)
				        		[0].innerText = newDec;
					        $(e.target).remove();
					    }
					});
			}

			//finding a class called color-n, cycles to next class color from 1 to numColors
			var cycleColor = function(e) {
				var numColors = <%= numColors %>;
				var element = $(e.currentTarget);
				var currentColor = parseInt(element.attr("data-color"));
				if (currentColor === numColors){
					var newColor = 1
				} else {
					var newColor = currentColor + 1;
				}
				console.log('color-'+String(currentColor));
				element.removeClass('color-'+String(currentColor))
						.addClass('color-' + String(newColor))
						.attr('data-color', newColor);
				if (element.parent().attr('data-color')) {
					element.parent().removeClass('color-' + String(currentColor))
						.addClass("color-" + String(newColor))
						.attr('data-color', newColor);
				}
			}

			var totalWidth = function(){
				var width = 0;
				$(".computed-width").each(function() {
					width += $(this).width();
				});
				return width;
			};
			// Adds % widths for each column in table with 'computed-width' css classes on headers
			var computeWidths = function(){
				// cannot trust that sum of all columns = width of table due to margin, border, and browser overflow rules
				width = totalWidth();
				$(".computed-width").each(function() {
					$(this).children(".percent").text(String(Math.round($(this).width() / width * 100)) + "%"); 
				});
			};

			//callback for column resizable
			var onSampleResized = function(e){	
				var table = $(e.currentTarget); //reference to the resized table
				computeWidths();
				calculateAllRanks();
			};
			// wrapper handler for Touch events to create drag events
			var handleTouch = function(event){
				event.preventDefault();
				var type, dispatchTarget;
				var touch = event.originalEvent.changedTouches[0];
				switch(event.type){
					case "touchstart": 
						type="dragstart"; 
						dispatchTarget = touch.target;
						break;
					case "touchmove": 
						type="drag"; 
						dispatchTarget = touch.target;
						break;
					case "touchend": 
						var dropSite = document.elementFromPoint(touch.clientX, touch.clientY);
						if (dropSite === event.target){
							dispatchTarget = event.target;
							type="click";
						} else {
							dispatchTarget = dropSite;
							type="drop";
						}
						break;
					default: return;
				}

				var simulatedMouse = document.createEvent("MouseEvent");
				//event.initMouseEvent(type, canBubble, cancelable, view,
    //                  detail (clicks), screenX, screenY, clientX, clientY,
    //                  ctrlKey, altKey, shiftKey, metaKey,
    //                  button (0: Main button pressed), relatedTarget);
				simulatedMouse.initMouseEvent(type, true, true, window, 
					1, touch.screenX, touch.screenY, touch.clientX, touch.clientY,
					false, false, false, false, 0, null);
				dispatchTarget.dispatchEvent(simulatedMouse);

			}
			var dragStart = function(event) {
				if (event.dataTransfer){
					event.dataTransfer.setData("text", event.target.id);
				} else {
					jQuery.Event.data = {"text": event.target.id};
				}
			}
			var dropEvent = function(event){
				event.preventDefault();
			  	event.stopPropagation();
			  	var mydiv = $(event.target);
			  	if (event.dataTransfer){
				    var data = event.dataTransfer.getData("text");
			  	} else {
				    var data = jQuery.Event.data["text"];
			  	}
			    
			    // make sure the target is the outer div - priority or all-criterias
				while (! (mydiv.hasClass('priority') || mydiv.hasClass('all-criterias')) ){
					mydiv = mydiv.parent();
				}

				//priority  = table headers
				//only allow to drop if empty
				if (mydiv.hasClass('priority') && mydiv.hasClass('empty')){
					var dragged = $('#' + data);
					//if being dragged from one column to another
					if (dragged.parent('priority')){
						var currentColor = dragged.attr('data-color');						
						dragged.parent().addClass('empty')
							.removeClass('color-' + currentColor)
							.removeData('color');
					}
					dragged.insertBefore(mydiv.children());
					mydiv.removeClass('empty');
					var currentColor = dragged.attr('data-color');
					mydiv.addClass('color-' + currentColor)
						.attr('data-color', currentColor);
				// if being dragged back to the pool of all criterias
				} else if (mydiv.hasClass('all-criterias')) {
					var dragged = $('#' + data);
					if (dragged.parent().hasClass('priority')) {
						var currentColor = dragged.attr('data-color');
						dragged.parent().addClass('empty')
							.removeClass('color-' + currentColor)
							.removeData('color');
					}
					dragged.insertBefore($('.new-criteria')[0]);
				}
			}
			// initialize column Resizable
			$("#decision-maker").colResizable({
				resizeMode:'fit',
				liveDrag:true,
				postbackSafe:true,
				partialRefresh:true,
				draggingClass:"dragging",
				onResize: onSampleResized,
				disabledColumns: [0],
				onDrag: onSampleResized
			});

			$(document).ready(function(){
				// compute initial column widths
				computeWidths();
				calculateAllRanks();
				// add onclick event to cycle color for all criterias
				$('.criteria').click(cycleColor);
				// make all criterias draggable
				$('.criteria').on("dragstart", dragStart);

				$('.criteria:not(.new-criteria)').on("touchstart", handleTouch);
				$('.criteria:not(.new-criteria)').on("touchmove", handleTouch);
				$('.criteria:not(.new-criteria)').on("touchend", handleTouch);
				$('.criteria:not(.new-criteria)').on("touchcancel", handleTouch);

				// make all-criterias and priority droppable
				$('.all-criterias, .priority').on("drop", dropEvent);
				$('.all-criterias, .priority').on("dragover", function(event){
					event.preventDefault();
					event.stopPropagation();
				});
				$('.input-allowed').on('click', allowEdit);
				$('.new-criteria').off('click', cycleColor);
				$('.new-criteria').on('click', newcriteria);
				$('.all-criterias-show').click(function(e){
					$('.all-criterias').toggleClass('hide');
				});
				$('.large-numbers-button label').click(toggleLargeNumbers);
				$('input[type=radio].rank-choice').change(calculateRank);
				$('#new-row').on('click', addChoice);
				$('.trash-button').click(deleteChoice);
				$('#save-button').click(postDecision);
				saveToken();
			})
		})
	</script>
	</body>
</html>
